<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ—è –ò–≥—Ä–∞ (Brython) ‚Äî –ù–µ—Å–∫–æ–ª—å–∫–æ –ò–ò (3‚Äì4 –∏–≥—Ä–æ–∫–æ–≤), –∑–µ–ª—ë–Ω–æ–µ –ø–æ–ª–µ + –∫–æ–∑—ã—Ä—å</title>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Brython -->
  <script src="https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js"></script>

  <!-- CSS —Å—Ç–∏–ª–∏ -->
  <style>
    /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
    body {
      margin: 0; 
      padding: 0;
      font-family: Arial, sans-serif;
      background: #eee; 
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      background: #3f51b5;
      color: white;
      width: 100%;
      padding: 1rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
    #menu-screen {
      background: white;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .container {
      background: white; 
      margin: 1rem;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    button {
      background: #3f51b5;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      cursor: pointer;
    }
    button:hover {
      background: #32408f;
    }

    /* –≠–∫—Ä–∞–Ω—ã (—Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ, –∫—Ä–æ–º–µ menu) */
    #newgame-screen, #achievements-screen, #rules-screen,
    #settings-screen, #game-screen, #aifull-screen, #aifull-multi-screen,
    #profile-screen {
      display: none;
    }

    #newgame-screen {
      width: 400px;
      min-height: 500px;
      margin: 2rem auto;
      box-sizing: border-box;
    }
    
    /* –ó–µ–ª–µ–Ω–æ–µ –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
    .game-field {
      background: #2e7d32;
      color: #fff;
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      padding: 1rem;
      box-sizing: border-box;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–∑—ã—Ä—è –∏ —Å—Ç–æ–ø–∫–∏ "–±–∏—Ç–æ" ‚Äì –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É */
    #aifull-screen .trump-discard-container,
    #aifull-multi-screen .trump-discard-container {
      display: flex;
      gap: 1rem;
      position: absolute;
      top: 20px;
      right: 20px;
      left: auto;
      z-index: 100;
    }
    .trump-discard-container {
      display: flex;
      gap: 1rem;
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 100;
    }
    /* –ö–æ–∑—ã—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞ */
    #trump-card, #trump-card-multi {
      width: 60px;
      height: 90px;
      background: #fff;
      color: #333;
      border: 2px solid #333;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
    }
    /* –°—Ç–æ–ø–∫–∞ "–±–∏—Ç–æ" ‚Äì —Ä–∞–∑–º–µ—Ä—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –∫–æ–∑—ã—Ä–Ω–æ–π –∫–∞—Ä—Ç–æ–π */
    #discard-pile, #discard-pile-multi {
      width: 60px;
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card-back {
      background: #333;
      border: 2px solid #666;
      border-radius: 10px;
      width: 60px;
      height: 90px;
    }

    /* –ó–µ–ª–µ–Ω—ã–π –ª–æ–≥ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫—Ä—ã—Ç) */
    .green-log {
      background: #2e7d32;
      color: #fff;
      border: 1px solid #4caf50;
      padding: 1rem;
      min-height: 150px;
      overflow-y: auto;
      margin-bottom: 1rem;
      border-radius: 5px;
    }

    /* –ö–∞—Ä—Ç–æ—á–Ω—ã–π –¥–∏–∑–∞–π–Ω */
    .card-list {
      margin: 0.5rem 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .card-item {
      background: #fff;
      color: #333;
      border: 2px solid #ccc;
      border-radius: 10px;
      width: 60px;
      height: 90px;
      margin: 0.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .card-item:hover {
      background: #f8f8f8;
    }

    .rules-block h3 {
      margin-top: 0.5rem;
      margin-bottom: 0.3rem;
    }
    .rules-block p {
      margin-top: 0.2rem;
      margin-bottom: 0.8rem;
      line-height: 1.4;
    }

    /* –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û: –æ–±—â–∏–π —Å—Ç–∏–ª—å action-message */
    .action-message {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: yellow;
      min-height: 1.8em;
    }

    /* –ö–Ω–æ–ø–∫–∞ "–í–∑—è—Ç—å –∫–∞—Ä—Ç—ã" –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ */
    .take-cards-btn {
      margin-left: 1rem;
      background: #c62828;
      border-color: #b71c1c;
    }

  </style>
</head>

<body onload="brython()">
<header>
  <h1>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –º–æ–µ–π –∏–≥—Ä—ã</h1>
</header>

<!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω) -->
<div class="container" id="menu-screen">
  <h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
  <button onclick="open_screen('newgame')">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button><br>
  <button onclick="open_screen('achievements')">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button><br>
  <button onclick="open_screen('rules')">–ü—Ä–∞–≤–∏–ª–∞</button><br>
  <button onclick="open_screen('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button><br>
  <!-- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞: –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç -->
  <button onclick="open_screen('profile')">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç" (profile) -->
<div class="container" id="profile-screen">
  <h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
  <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:</p>
  <input type="text" id="player_name_input" value="–ò–≥—Ä–æ–∫" style="width:200px;" />
  <br><br>
  <button onclick="save_player_name()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button onclick="back_to_menu()">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–ù–æ–≤–∞—è –∏–≥—Ä–∞" -->
<div class="container" id="newgame-screen">
  <h2>–ù–æ–≤–∞—è –∏–≥—Ä–∞</h2>
  <label>–†–µ–∂–∏–º –∏–≥—Ä—ã:</label><br>
  <select id="select_mode">
    <option value="classic">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π</option>
    <option value="podkidnoi">–ü–æ–¥–∫–∏–¥–Ω–æ–π</option>
    <option value="perevodnoi">–ü–µ—Ä–µ–≤–æ–¥–Ω–æ–π</option>
    <option value="jokers">–° –¥–∂–æ–∫–µ—Ä–∞–º–∏</option>
    <option value="all">–í—Å–µ —Å—Ä–∞–∑—É</option>
  </select>
  <br><br>

  <label>
    <input type="checkbox" id="cb_jokers">
    –ò–≥—Ä–∞ —Å –¥–∂–æ–∫–µ—Ä–∞–º–∏
  </label>
  <br><br>

  <label>
    <input type="checkbox" id="cb_6plus">
    –ö–∞—Ä—Ç—ã —Ç–æ–ª—å–∫–æ 6..A
  </label>
  <br><br>

  <!-- AI –≤—ã–±–æ—Ä (2..4) -->
  <div id="ai-count-block" style="display:none; margin-bottom:1rem;">
    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (1 —Ä–µ–∞–ª—å–Ω—ã–π + (N-1) –ò–ò), –æ—Ç 2 –¥–æ 4:</label><br>
    <input type="number" id="ai_players_count" value="2" min="2" max="4" />
  </div>

  <!-- –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä (2..10) -->
  <div id="multi-count-block" style="display:none; margin-bottom:1rem;">
    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (2..10):</label><br>
    <input type="number" id="multi_players_count" value="4" min="2" max="10" />
    <br><br>
    <p>–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä: –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø –∫–æ–º–Ω–∞—Ç—ã:</p>
    <label>
      <input type="radio" name="room_type" value="link" checked>
      –ü–æ —Å—Å—ã–ª–∫–µ
    </label><br>
    <label>
      <input type="radio" name="room_type" value="open">
      –û—Ç–∫—Ä—ã—Ç–∞—è
    </label>
  </div>

  <label>–¢–∏–ø –∏–≥—Ä—ã:</label><br>
  <label>
    <input type="radio" name="game_type" value="ai" checked>
    –ò–≥—Ä–∞ —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é
  </label><br>
  <label>
    <input type="radio" name="game_type" value="multi">
    –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä
  </label>
  <br><br>

  <button onclick="start_new_game()">–ù–∞—á–∞—Ç—å</button>
  <button onclick="back_to_menu()">–û—Ç–º–µ–Ω–∞</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è" -->
<div class="container" id="achievements-screen">
  <h2>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
  <p>–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –ø–æ–∫–∞ –ø—É—Å—Ç.</p>
  <button onclick="back_to_menu()">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–ü—Ä–∞–≤–∏–ª–∞" -->
<div class="container" id="rules-screen">
  <h2>–ü—Ä–∞–≤–∏–ª–∞</h2>
  <div class="rules-block">
    <p>–í –∏–≥—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–ª–æ–¥–∞ –∏–∑ 7 –º–∞—Å—Ç–µ–π (‚ô†, ‚ô•, ‚ô¶, ‚ô£, ‚≠ê, üåô, ‚öú)
    –∏ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ 2 –æ—Å–æ–±—ã—Ö –¥–∂–æ–∫–µ—Ä–∞.
    –ú–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å –∫–∞—Ä—Ç–∞–º–∏ –æ—Ç 2 –¥–æ A, –∏–ª–∏ —Ç–æ–ª—å–∫–æ —Å 6..A, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫.</p>

    <h3>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –¥—É—Ä–∞–∫:</h3>
    <p>–û–±—ã—á–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: –∏–≥—Ä–æ–∫–∏ –∑–∞—â–∏—â–∞—é—Ç—Å—è –∏ (–ø—Ä–∏ –ø–æ–¥–∫–∏–¥–Ω–æ–º) –ø–æ–¥–∫–∏–¥—ã–≤–∞—é—Ç, –±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–æ–≤.
    –ö–æ–∑—ã—Ä–Ω–∞—è –º–∞—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω–æ. –î–∂–æ–∫–µ—Ä—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è,
    –µ—Å–ª–∏ –Ω–µ –æ—Ç–º–µ—á–µ–Ω–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.</p>

    <h3>–ü–æ–¥–∫–∏–¥–Ω–æ–π –¥—É—Ä–∞–∫:</h3>
    <p>–†–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è –ø–æ–¥–∫–∏–¥—ã–≤–∞—Ç—å –∫–∞—Ä—Ç—ã —Ç–æ–≥–æ –∂–µ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞, —á—Ç–æ —É–∂–µ –Ω–∞ —Å—Ç–æ–ª–µ.
    –î–∂–æ–∫–µ—Ä—ã (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã) –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç—ã.</p>

    <h3>–ü–µ—Ä–µ–≤–æ–¥–Ω–æ–π –¥—É—Ä–∞–∫:</h3>
    <p>–ï—Å–ª–∏ –æ—Ç–±–∏–≤–∞—é—â–∏–π—Å—è –º–æ–∂–µ—Ç –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Ö–æ–¥ (–µ—Å—Ç—å –∫–∞—Ä—Ç–∞ —Ç–æ–≥–æ –∂–µ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞),
    –æ–Ω –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –∞—Ç–∞–∫—É –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞. –ù–∞–ª–∏—á–∏–µ 7 –º–∞—Å—Ç–µ–π –∏ 2 –¥–∂–æ–∫–µ—Ä–æ–≤
    –¥–æ–±–∞–≤–ª—è–µ—Ç –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏.</p>

    <h3>–° –¥–∂–æ–∫–µ—Ä–∞–º–∏ (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º):</h3>
    <p>–í—Å–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞, –Ω–æ –¥–∂–æ–∫–µ—Ä—ã –∏–≥—Ä–∞—é—Ç –æ—Å–æ–±—É—é —Ä–æ–ª—å,
    –º–æ–≥—É—Ç –±–∏—Ç—å –ª—é–±—ã–µ –∫–∞—Ä—Ç—ã, –∏–ª–∏ –¥–∞–∂–µ —Å—á–∏—Ç–∞—Ç—å—Å—è –∫–æ–∑—ã—Ä—è–º–∏ (–≤ —É–ø—Ä–æ—â—ë–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏).
    –ö–æ–ª–æ–¥–∞ —Å–Ω–æ–≤–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å 2..A –∏–ª–∏ 6..A –ø–ª—é—Å 2 –¥–∂–æ–∫–µ—Ä–∞.</p>

    <h3>–í—Å–µ —Å—Ä–∞–∑—É:</h3>
    <p>–û–±—ä–µ–¥–∏–Ω—è–µ—Ç –º–µ—Ö–∞–Ω–∏–∫–∏ –ø–æ–¥–∫–∏–¥–Ω–æ–≥–æ, –ø–µ—Ä–µ–≤–æ–¥–Ω–æ–≥–æ –∏ —Å –¥–∂–æ–∫–µ—Ä–∞–º–∏.
    –≠—Ç–æ —Å–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –º–Ω–æ–≥–æ –∫–∞—Ä—Ç (7 –º–∞—Å—Ç–µ–π, 2 –¥–∂–æ–∫–µ—Ä–∞),
    –º–æ–∂–Ω–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –∏ –ø–æ–¥–∫–∏–¥—ã–≤–∞—Ç—å. –û—á–µ–Ω—å —Ö–∞–æ—Ç–∏—á–Ω–æ –∏ –≤–µ—Å–µ–ª–æ!</p>
  </div>
  <button onclick="back_to_menu()">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" -->
<div class="container" id="settings-screen">
  <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
  <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç —Ç—É—Ç...</p>
  <button onclick="back_to_menu()">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–ò–≥—Ä–∞" (–¥–ª—è MULTI –∏–ª–∏ AI>2) -->
<div class="container" id="game-screen">
  <h2>–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!</h2>
  <p>–í—ã –≤—ã–±—Ä–∞–ª–∏:</p>
  <p><strong>–†–µ–∂–∏–º:</strong> <span id="chosen_mode"></span></p>
  <p><strong>–î–∂–æ–∫–µ—Ä—ã:</strong> <span id="chosen_jokers"></span></p>
  <p><strong>–¢–æ–ª—å–∫–æ 6..A:</strong> <span id="chosen_6plus"></span></p>
  <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤:</strong> <span id="chosen_players"></span></p>
  <p><strong>–¢–∏–ø –∏–≥—Ä—ã:</strong> <span id="chosen_type"></span> 
    ( <span id="chosen_room"></span> )
  </p>
  <button onclick="back_to_menu()">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "aifull-screen" (2 –∏–≥—Ä–æ–∫–∞) -->
<div class="container game-field" id="aifull-screen">
  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–∑—ã—Ä—è –∏ —Å—Ç–æ–ø–∫–∏ "–±–∏—Ç–æ" –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
  <div class="trump-discard-container">
    <div id="trump-card">?</div>
    <div id="discard-pile" style="display:none;"></div>
  </div>
  <h2>–ü–æ–ª–Ω–∞—è –ø–∞—Ä—Ç–∏—è —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é (2 –∏–≥—Ä–æ–∫–∞)</h2>
  <p>–ö—Ç–æ –ø–µ—Ä–≤—ã–π —Å–±—Ä–æ—Å–∏—Ç –∫–∞—Ä—Ç—ã ‚Äî —Ç–æ—Ç –≤—ã–∏–≥—Ä–∞–ª!</p>
  <p>–¢–µ–∫—É—â–∏–π —Ö–æ–¥: <span id="current-turn"></span></p>

  <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ —Ö–æ–¥–µ -->
  <div id="aifull-action" class="action-message"></div>

  <div id="aifull-log" class="green-log"></div>
  <!-- –ö–∞—Ä—Ç—ã –Ω–∞ —Å—Ç–æ–ª–µ (–Ω–µ –±–æ–ª–µ–µ 2 –∑–∞ –∫–æ–Ω) -->
  <div id="aifull-visual-cards" style="margin-bottom:1rem; display:flex; gap:1rem; flex-wrap:wrap;"></div>
  
  <hr>
  <p><strong>–í–∞—à–∏ –∫–∞—Ä—Ç—ã:</strong></p>
  <ul class="card-list" id="user-cards-list"></ul>

  <!-- –ö–Ω–æ–ø–∫–∞ "–í–∑—è—Ç—å –∫–∞—Ä—Ç—ã", –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –Ω–µ —Ö–æ—á–µ—Ç/–Ω–µ –º–æ–∂–µ—Ç –æ—Ç–±–∏—Ç—å—Å—è -->
  <button class="take-cards-btn" id="take-cards-2p" style="display:none;">–í–∑—è—Ç—å –∫–∞—Ä—Ç—ã</button>
  <br><br>

  <button onclick="restart_aifull()">–°—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
  <button onclick="back_to_menu()">–í—ã–π—Ç–∏ –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "aifull-multi-screen" (3..4 –∏–≥—Ä–æ–∫–æ–≤) -->
<div class="container game-field" id="aifull-multi-screen">
  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–∑—ã—Ä—è –∏ —Å—Ç–æ–ø–∫–∏ "–±–∏—Ç–æ" –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
  <div class="trump-discard-container">
    <div id="trump-card-multi">?</div>
    <div id="discard-pile-multi" style="display:none;"></div>
  </div>
  <h2>–ü–æ–ª–Ω–∞—è –ø–∞—Ä—Ç–∏—è —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ò–ò (3‚Äì4 –∏–≥—Ä–æ–∫–æ–≤)</h2>
  <p>–ö—Ç–æ –ø–µ—Ä–≤—ã–π —Å–±—Ä–æ—Å–∏—Ç –∫–∞—Ä—Ç—ã ‚Äî —Ç–æ—Ç –≤—ã–∏–≥—Ä–∞–ª!<br>
     –¢–µ–∫—É—â–∏–π —Ö–æ–¥: <span id="multi-turn"></span></p>

  <div id="aifull-multi-action" class="action-message"></div>

  <div id="aifull-multi-log" class="green-log"></div>
  <div id="aifull-multi-visual-cards" style="margin-bottom:1rem; display:flex; gap:1rem; flex-wrap:wrap;"></div>
  
  <hr>
  <p><strong>–í–∞—à–∏ –∫–∞—Ä—Ç—ã:</strong></p>
  <ul class="card-list" id="user-multi-cards"></ul>

  <!-- –ö–Ω–æ–ø–∫–∞ "–í–∑—è—Ç—å –∫–∞—Ä—Ç—ã" -->
  <button class="take-cards-btn" id="take-cards-multi" style="display:none;">–í–∑—è—Ç—å –∫–∞—Ä—Ç—ã</button>
  <br><br>

  <button onclick="restart_aifull_multi()">–°—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
  <button onclick="back_to_menu()">–í—ã–π—Ç–∏ –≤ –º–µ–Ω—é</button>
</div>

<script type="text/python">
#######################################
#   –ú–æ–¥—É–ª—å Brython: –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
#######################################
from browser import document, window, timer
import random

########################################################
#          –£—Ç–∏–ª–∏—Ç—ã –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
########################################################

def switch_view(show_id):
    screens = [
        "menu-screen","newgame-screen","achievements-screen","rules-screen",
        "settings-screen","game-screen","aifull-screen","aifull-multi-screen",
        "profile-screen"
    ]
    for s in screens:
        document[s].style.display = "none"
    document[show_id].style.display = "block"

def back_to_menu():
    # –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å–ª—É—á–∞–π –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
    if "trump-card" in document:
        document["trump-card"].style.display = "none"
    if "trump-card-multi" in document:
        document["trump-card-multi"].style.display = "none"
    if "discard-pile" in document:
        document["discard-pile"].style.display = "none"
        document["discard-pile"].clear()
    if "discard-pile-multi" in document:
        document["discard-pile-multi"].style.display = "none"
        document["discard-pile-multi"].clear()

    switch_view("menu-screen")

def open_screen(name):
    switch_view(name+"-screen")

def on_game_type_change(ev):
    check_game_type()

def check_game_type():
    radio_list = document.select("[name='game_type']")
    chosen = "ai"
    for r in radio_list:
        if r.checked:
            chosen = r.value
            break
    ai_block = document["ai-count-block"]
    multi_block = document["multi-count-block"]
    if chosen=="ai":
        ai_block.style.display = "block"
        multi_block.style.display = "none"
    else:
        ai_block.style.display = "none"
        multi_block.style.display = "block"

def init():
    for r in document.select("[name='game_type']"):
        r.bind("change", on_game_type_change)
    check_game_type()

init()

player_name = "–ò–≥—Ä–æ–∫"
def save_player_name():
    global player_name
    inp = document["player_name_input"].value
    if inp.strip():
        player_name = inp.strip()
    back_to_menu()

########################################################
#   –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–¥—ã –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞—Ä—Ç
########################################################

def rank_index(rank):
    order = ["2","3","4","5","6","7","8","9","10","J","Q","K","A"]
    return order.index(rank) if rank in order else -1

def can_defend(card_def, card_atk, trump_suit):
    rd, sd, jd = card_def
    ra, sa, ja = card_atk
    if jd:
        if ja:
            return False
        return True
    if ja:
        return False

    is_trump_def = (sd == trump_suit)
    is_trump_atk = (sa == trump_suit)

    if is_trump_def and not is_trump_atk:
        return True
    if not is_trump_def and is_trump_atk:
        return False

    if sd == sa:
        return rank_index(rd) > rank_index(ra)

    return False

def draw_until_6(hand, deck):
    while len(hand) < 6 and len(deck) > 0:
        hand.append(deck.pop(0))
    return hand

def create_deck(only_6plus, with_jokers):
    suits = ["‚ô†","‚ô•","‚ô¶","‚ô£","‚≠ê","üåô","‚öú"]
    ranks_all = [str(n) for n in range(2,11)] + ["J","Q","K","A"]
    if only_6plus:
        ranks_all = [r for r in ranks_all if r not in ["2","3","4","5"]]

    d = []
    for s in suits:
        for r in ranks_all:
            d.append((r,s,False))
    if with_jokers:
        d.append(("Joker-3","JokerSuit",True))
        d.append(("Joker-4","JokerSuit",True))
    return d

def clear_visual_cards(parent_id):
    container = document[parent_id]
    container.clear()

########################################################
#   –û—á–µ—Ä–µ–¥—å (queue) –¥–ª—è –ø–æ—ç—Ç–∞–ø–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π/–∫–∞—Ä—Ç (–¥–µ–π—Å—Ç–≤–∏–π –ò–ò)
########################################################
_card_queue = []
_busy = False

def delayed_show_next():
    global _card_queue, _busy
    if not _card_queue:
        _busy = False
        return
    _busy = True

    item = _card_queue.pop(0)
    kind = item[0]

    if kind == 'message':
        screen_id = item[1]
        txt = item[2]
        document[screen_id + "-action"].innerHTML = txt

    elif kind == 'card':
        card = item[1]
        parent_id = item[2]
        cont = document[parent_id]
        new_div = document.createElement("div")
        new_div.classList.add("card-item")
        rank, suit, jk = card
        card_text = "Joker" if jk else f"{rank}{suit}"
        new_div.innerHTML = card_text
        cont.appendChild(new_div)

    elif kind == 'function':
        callback = item[1]
        callback()

    timer.set_timeout(delayed_show_next, 2000)

def queue_message(screen_id, txt):
    global _card_queue, _busy
    _card_queue.append(('message', screen_id, txt))
    if not _busy:
        _busy = True
        timer.set_timeout(delayed_show_next, 2000)

def queue_card(card, parent_id):
    global _card_queue, _busy
    _card_queue.append(('card', card, parent_id))
    if not _busy:
        _busy = True
        timer.set_timeout(delayed_show_next, 2000)

def queue_function(callback):
    global _card_queue, _busy
    _card_queue.append(('function', callback))
    if not _busy:
        _busy = True
        timer.set_timeout(delayed_show_next, 2000)

def clear_action_message(screen_id):
    document[screen_id + "-action"].innerHTML = ""

def discard_cards_bito(screen_id, field_id, pile_id):
    if pile_id in document:
        document[field_id].clear()
        pile = document[pile_id]
        pile.clear()
        pile.style.display = "flex"
        new_div = document.createElement("div")
        new_div.classList.add("card-back")
        pile.appendChild(new_div)

########################################################
#   –õ–û–ì–ò–ö–ê –î–õ–Ø 2 –ò–ì–†–û–ö–û–í (aifull)
########################################################

deck_2p = []
AI_cards = []
user_cards = []
trump_suit_2p = ""
current_attacker_2p = "AI"
table_cards_2p = []
game_over_2p_flag = False

eliminated_2p = {"player": False, "AI": False}

def determine_first_attacker_2p():
    player_trumps = [c for c in user_cards if c[1] == trump_suit_2p]
    ai_trumps = [c for c in AI_cards if c[1] == trump_suit_2p]
    if player_trumps or ai_trumps:
        player_min = min([rank_index(card[0]) for card in player_trumps], default=999)
        ai_min = min([rank_index(card[0]) for card in ai_trumps], default=999)
        if player_min < ai_min:
            return "player"
        else:
            return "AI"
    else:
        return "player"

def start_aifull_game(only_6plus, with_jokers):
    global deck_2p, AI_cards, user_cards, trump_suit_2p
    global current_attacker_2p, table_cards_2p, game_over_2p_flag
    global eliminated_2p, _card_queue, _busy

    _card_queue = []
    _busy = False

    deck_2p = create_deck(only_6plus, with_jokers)
    random.shuffle(deck_2p)

    AI_cards = deck_2p[:6]
    user_cards = deck_2p[6:12]
    del deck_2p[:12]

    suits = ["‚ô†","‚ô•","‚ô¶","‚ô£","‚≠ê","üåô","‚öú"]
    trump_suit_2p = random.choice(suits)

    current_attacker_2p = determine_first_attacker_2p()

    table_cards_2p = []
    game_over_2p_flag = False
    eliminated_2p["player"] = False
    eliminated_2p["AI"] = False

    document["trump-card"].innerHTML = f"<div style='font-size:1.5rem;'>{trump_suit_2p}</div>"
    document["trump-card"].style.display = "flex"

    clear_visual_cards("aifull-visual-cards")
    document["discard-pile"].clear()
    document["discard-pile"].style.display = "none"

    document["take-cards-2p"].style.display = "none"

    switch_view("aifull-screen")
    update_aifull_ui()

    if current_attacker_2p == "AI":
        document["aifull-action"].innerHTML = "–°–µ–ª–µ—Å—Ç–∏—è —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º (–∞—Ç–∞–∫–∞)."
    else:
        document["aifull-action"].innerHTML = f"{player_name} —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º (–∞—Ç–∞–∫–∞)."

    start_con_2p()

def update_aifull_ui():
    document["aifull-log"].innerHTML = ""
    turn_text = ("–°–µ–ª–µ—Å—Ç–∏—è" if current_attacker_2p=="AI" else player_name)
    document["current-turn"].textContent = turn_text

    ul = document["user-cards-list"]
    ul.clear()
    for i, c in enumerate(user_cards):
        li = document.createElement("li")
        li.classList.add("card-item")
        rank, suit, jk = c
        li.innerHTML = "Joker" if jk else f"{rank}{suit}"
        def on_click(ev, idx=i):
            user_card_clicked_2p(idx)
        li.bind("click", on_click)
        ul.appendChild(li)

    check_winner_2p()

def check_winner_2p():
    global game_over_2p_flag
    if game_over_2p_flag:
        return

    if len(user_cards)==0 and not eliminated_2p["player"]:
        eliminated_2p["player"] = True
        game_over_2p_flag = True
        document["aifull-action"].innerHTML = f"{player_name} –≤—ã–∏–≥—Ä–∞–ª!"
        return
    elif len(AI_cards)==0 and not eliminated_2p["AI"]:
        eliminated_2p["AI"] = True
        game_over_2p_flag = True
        document["aifull-action"].innerHTML = "–°–µ–ª–µ—Å—Ç–∏—è –≤—ã–∏–≥—Ä–∞–ª!"
        return

def start_con_2p():
    if eliminated_2p["player"] or eliminated_2p["AI"]:
        return

    table_cards_2p.clear()
    document["aifull-visual-cards"].clear()

    if current_attacker_2p == "AI":
        queue_function(ai_attack_2p)
    else:
        pass

def ai_attack_2p():
    if not AI_cards:
        return

    ai_cards_sorted = sorted(AI_cards, key=lambda x: rank_index(x[0]))
    attack_card = ai_cards_sorted[0]
    table_cards_2p.append(attack_card)
    AI_cards.remove(attack_card)

    queue_message("aifull", "–°–µ–ª–µ—Å—Ç–∏—è –∞—Ç–∞–∫—É–µ—Ç –∫–∞—Ä—Ç–æ–π:")
    queue_card(attack_card, "aifull-visual-cards")
    queue_function(lambda: user_defense_phase_2p())

def user_defense_phase_2p():
    if not table_cards_2p:
        return
    atk_card = table_cards_2p[0]
    possible = [c for c in user_cards if can_defend(c, atk_card, trump_suit_2p)]
    if possible:
        document["take-cards-2p"].style.display = "none"
        document["aifull-action"].innerHTML = f"{player_name}, —É –≤–∞—Å –µ—Å—Ç—å —á–µ–º –æ—Ç–±–∏—Ç—å—Å—è!"
    else:
        document["take-cards-2p"].style.display = "inline-block"
        document["aifull-action"].innerHTML = f"{player_name}, –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–±–∏—Ç—å—Å—è? –í–æ–∑—å–º–∏—Ç–µ –∫–∞—Ä—Ç—ã."

def user_card_clicked_2p(idx):
    if eliminated_2p["player"] or eliminated_2p["AI"]:
        return
    if game_over_2p_flag:
        return

    if len(table_cards_2p)==0 and current_attacker_2p=="player":
        attack_card = user_cards[idx]
        table_cards_2p.append(attack_card)
        user_cards.pop(idx)
        display_user_card(attack_card, "aifull-visual-cards", f"{player_name} –∞—Ç–∞–∫—É–µ—Ç:")
        timer.set_timeout(ai_defense_2p, 500)

    elif len(table_cards_2p)==1 and current_attacker_2p=="AI":
        defend_card = user_cards[idx]
        atk_card = table_cards_2p[0]
        if can_defend(defend_card, atk_card, trump_suit_2p):
            table_cards_2p.append(defend_card)
            user_cards.pop(idx)
            document["take-cards-2p"].style.display = "none"

            display_user_card(defend_card, "aifull-visual-cards", f"{player_name} –∑–∞—â–∏—â–∞–µ—Ç—Å—è –∫–∞—Ä—Ç–æ–π:")
            document["aifull-action"].innerHTML = "–ó–∞—â–∏—Ç–∞ —É—Å–ø–µ—à–Ω–∞!"

            timer.set_timeout(lambda: finish_con_2p(True), 1000)
        else:
            document["aifull-action"].innerHTML = "–≠—Ç–æ–π –∫–∞—Ä—Ç–æ–π –æ—Ç–±–∏—Ç—å—Å—è –Ω–µ–ª—å–∑—è!"
    else:
        pass

def display_user_card(card, parent_id, message_text):
    document["aifull-action"].innerHTML = message_text
    container = document[parent_id]
    new_div = document.createElement("div")
    new_div.classList.add("card-item")
    rank, suit, jk = card
    card_text = "Joker" if jk else f"{rank}{suit}"
    new_div.innerHTML = card_text
    container.appendChild(new_div)

def ai_defense_2p():
    if not AI_cards or not table_cards_2p:
        return
    atk_card = table_cards_2p[0]
    possible_defenses = [c for c in AI_cards if can_defend(c, atk_card, trump_suit_2p)]
    if possible_defenses:
        possible_defenses.sort(key=lambda x: rank_index(x[0]))
        def_card = possible_defenses[0]
        AI_cards.remove(def_card)
        table_cards_2p.append(def_card)

        queue_message("aifull", "–°–µ–ª–µ—Å—Ç–∏—è –∑–∞—â–∏—â–∞–µ—Ç—Å—è –∫–∞—Ä—Ç–æ–π:")
        queue_card(def_card, "aifull-visual-cards")
        queue_message("aifull", "–ó–∞—â–∏—Ç–∞ —É—Å–ø–µ—à–Ω–∞!")
        queue_function(lambda: finish_con_2p(True))
    else:
        queue_message("aifull", "–°–µ–ª–µ—Å—Ç–∏—è –Ω–µ –æ—Ç–±–∏–ª—Å—è –∏ –±–µ—Ä—ë—Ç –∫–∞—Ä—Ç—ã.")
        queue_function(lambda: finish_con_2p(False))

def finish_con_2p(success):
    global current_attacker_2p

    document["take-cards-2p"].style.display = "none"

    if success:
        discard_cards_bito("aifull", "aifull-visual-cards", "discard-pile")
        if current_attacker_2p=="AI":
            current_attacker_2p="player"
        else:
            current_attacker_2p="AI"
    else:
        if current_attacker_2p=="AI":
            user_cards.extend(table_cards_2p)
        else:
            AI_cards.extend(table_cards_2p)
        document["aifull-visual-cards"].clear()
        table_cards_2p.clear()

    table_cards_2p.clear()
    document["aifull-visual-cards"].clear()

    if not game_over_2p_flag:
        if current_attacker_2p=="AI":
            AI_cards[:] = draw_until_6(AI_cards, deck_2p)
            user_cards[:] = draw_until_6(user_cards, deck_2p)
        else:
            user_cards[:] = draw_until_6(user_cards, deck_2p)
            AI_cards[:] = draw_until_6(AI_cards, deck_2p)

    update_aifull_ui()

    if not game_over_2p_flag:
        start_con_2p()

def take_cards_2p(ev):
    if len(table_cards_2p)==0:
        return
    if current_attacker_2p!="AI":
        return

    # --- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –Ø–≤–Ω–æ —Å–æ–æ–±—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    document["aifull-action"].innerHTML = "–í—ã –≤–∑—è–ª–∏ –∫–∞—Ä—Ç—ã!"

    user_cards.extend(table_cards_2p)
    table_cards_2p.clear()
    document["aifull-visual-cards"].clear()
    document["take-cards-2p"].style.display = "none"

    update_aifull_ui()

    if not game_over_2p_flag:
        if current_attacker_2p=="AI":
            AI_cards[:] = draw_until_6(AI_cards, deck_2p)
            user_cards[:] = draw_until_6(user_cards, deck_2p)
    start_con_2p()

def restart_aifull():
    jokers_checked = document["cb_jokers"].checked
    sixplus_checked = document["cb_6plus"].checked
    start_aifull_game(sixplus_checked, jokers_checked)

########################################################
#   –õ–û–ì–ò–ö–ê –î–õ–Ø 3..4 –ò–ì–†–û–ö–û–í (aifull-multi)
########################################################

deck_multi = []
hands = []
trump_multi = ""
eliminated_multi = []
current_attacker_multi = 0
table_cards_multi = []
game_over_multi_flag = False
n_players_multi = 0

def start_aifull_multi(only_6plus, with_jokers, total):
    global deck_multi, hands, trump_multi, eliminated_multi
    global current_attacker_multi, table_cards_multi, game_over_multi_flag
    global n_players_multi, _card_queue, _busy

    _card_queue = []
    _busy = False

    n_players_multi = total

    deck_multi = create_deck(only_6plus, with_jokers)
    random.shuffle(deck_multi)

    hands = []
    off = 0
    for i in range(n_players_multi):
        h = deck_multi[off:off+6]
        off+=6
        hands.append(h)

    deck_multi = deck_multi[off:]

    suits = ["‚ô†","‚ô•","‚ô¶","‚ô£","‚≠ê","üåô","‚öú"]
    trump_multi = random.choice(suits)

    eliminated_multi = [False]*n_players_multi

    current_attacker_multi = determine_first_attacker_multi()
    table_cards_multi = []
    game_over_multi_flag = False

    document["trump-card-multi"].innerHTML = f"<div style='font-size:1.5rem;'>{trump_multi}</div>"
    document["trump-card-multi"].style.display = "flex"

    clear_visual_cards("aifull-multi-visual-cards")
    document["discard-pile-multi"].clear()
    document["discard-pile-multi"].style.display = "none"

    document["take-cards-multi"].style.display = "none"

    switch_view("aifull-multi-screen")
    update_aifull_multi_ui()

    if current_attacker_multi==0:
        document["aifull-multi-action"].innerHTML = f"{player_name} —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º."
    else:
        document["aifull-multi-action"].innerHTML = f"{get_ai_name(current_attacker_multi)} —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º."

    start_con_multi()

def determine_first_attacker_multi():
    best_val = 999
    best_idx = 0
    for i, hand in enumerate(hands):
        trump_cards = [c for c in hand if c[1]==trump_multi]
        if trump_cards:
            local_min = min(rank_index(x[0]) for x in trump_cards)
            if local_min < best_val:
                best_val = local_min
                best_idx = i
    return best_idx

def update_aifull_multi_ui():
    if current_attacker_multi==0:
        document["multi-turn"].textContent = player_name
    else:
        document["multi-turn"].textContent = get_ai_name(current_attacker_multi)

    ul = document["user-multi-cards"]
    ul.clear()
    for i, c in enumerate(hands[0]):
        li = document.createElement("li")
        li.classList.add("card-item")
        rank, suit, jk = c
        li.innerHTML = "Joker" if jk else f"{rank}{suit}"
        def on_click(ev, idx=i):
            user_card_clicked_multi(idx)
        li.bind("click", on_click)
        ul.appendChild(li)

    check_winner_multi()

def check_winner_multi():
    global game_over_multi_flag
    if game_over_multi_flag:
        return

    active_players = [i for i, e in enumerate(eliminated_multi) if not e]
    if len(active_players)<=1:
        if len(active_players)==1:
            loser_idx = active_players[0]
            if loser_idx==0:
                document["aifull-multi-action"].innerHTML = "–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏..."
            else:
                document["aifull-multi-action"].innerHTML = f"{get_ai_name(loser_idx)} –ø—Ä–æ–∏–≥—Ä–∞–ª –ø–æ—Å–ª–µ–¥–Ω–∏–º!"
        else:
            document["aifull-multi-action"].innerHTML = "–í—Å–µ –≤—ã—à–ª–∏?"
        game_over_multi_flag = True
        return

    for i in active_players:
        if len(hands[i])==0 and not eliminated_multi[i]:
            eliminated_multi[i] = True
            if i==0:
                document["aifull-multi-action"].innerHTML = f"{player_name} –≤—ã–∏–≥—Ä–∞–ª –∏ –ø–æ–∫–∏–¥–∞–µ—Ç –∏–≥—Ä—É!"
            else:
                document["aifull-multi-action"].innerHTML = f"{get_ai_name(i)} –≤—ã–∏–≥—Ä–∞–ª –∏ –ø–æ–∫–∏–¥–∞–µ—Ç –∏–≥—Ä—É!"

def start_con_multi():
    global table_cards_multi
    table_cards_multi = []
    clear_visual_cards("aifull-multi-visual-cards")

    if check_game_over_multi():
        return

    if current_attacker_multi==0:
        pass
    else:
        queue_function(lambda: ai_attack_multi(current_attacker_multi))

def check_game_over_multi():
    active_players = [i for i, e in enumerate(eliminated_multi) if not e]
    if len(active_players)<=1:
        update_aifull_multi_ui()
        return True
    return False

def user_card_clicked_multi(idx):
    if game_over_multi_flag:
        return
    if eliminated_multi[0]:
        return

    if len(table_cards_multi)==0 and current_attacker_multi==0:
        attack_card = hands[0][idx]
        table_cards_multi.append((0, attack_card))
        hands[0].pop(idx)
        display_user_card_multi(attack_card, "aifull-multi-visual-cards", f"{player_name} –∞—Ç–∞–∫—É–µ—Ç:")
        defender = find_next_alive_player(current_attacker_multi)
        if defender==0:
            return
        if defender is not None and defender!=0:
            queue_function(lambda: ai_defense_multi(defender))
    else:
        attacker = current_attacker_multi
        if attacker==0:
            return
        if len(table_cards_multi)==1 and table_cards_multi[0][0]==attacker:
            defend_card = hands[0][idx]
            attack_card = table_cards_multi[0][1]
            if can_defend(defend_card, attack_card, trump_multi):
                table_cards_multi.append((0, defend_card))
                hands[0].pop(idx)
                display_user_card_multi(defend_card, "aifull-multi-visual-cards", f"{player_name} –∑–∞—â–∏—â–∞–µ—Ç—Å—è:")
                document["aifull-multi-action"].innerHTML = "–ó–∞—â–∏—Ç–∞ —É—Å–ø–µ—à–Ω–∞!"
                timer.set_timeout(lambda: finish_con_multi(True), 1000)
            else:
                document["aifull-multi-action"].innerHTML = "–≠—Ç–æ–π –∫–∞—Ä—Ç–æ–π –æ—Ç–±–∏—Ç—å—Å—è –Ω–µ–ª—å–∑—è!"
        else:
            pass

def display_user_card_multi(card, parent_id, message_text):
    document["aifull-multi-action"].innerHTML = message_text
    container = document[parent_id]
    new_div = document.createElement("div")
    new_div.classList.add("card-item")
    rank, suit, jk = card
    card_text = "Joker" if jk else f"{rank}{suit}"
    new_div.innerHTML = card_text
    container.appendChild(new_div)

def ai_attack_multi(ai_idx):
    if eliminated_multi[ai_idx]:
        return
    if not hands[ai_idx]:
        return

    sorted_ai = sorted(hands[ai_idx], key=lambda x: rank_index(x[0]))
    atk_card = sorted_ai[0]
    hands[ai_idx].remove(atk_card)
    table_cards_multi.append((ai_idx, atk_card))

    queue_message("aifull-multi", f"{get_ai_name(ai_idx)} –∞—Ç–∞–∫—É–µ—Ç –∫–∞—Ä—Ç–æ–π:")
    queue_card(atk_card, "aifull-multi-visual-cards")

    defender = find_next_alive_player(ai_idx)
    if defender is not None:
        if defender==0:
            queue_function(lambda: user_defense_phase_multi())
        else:
            queue_function(lambda: ai_defense_multi(defender))

def user_defense_phase_multi():
    if len(table_cards_multi)==0:
        return
    atk_card = table_cards_multi[0][1]
    possible = [c for c in hands[0] if can_defend(c, atk_card, trump_multi)]
    if possible:
        document["take-cards-multi"].style.display = "none"
        document["aifull-multi-action"].innerHTML = f"{player_name}, —É –≤–∞—Å –µ—Å—Ç—å —á–µ–º –æ—Ç–±–∏—Ç—å—Å—è!"
    else:
        document["take-cards-multi"].style.display = "inline-block"
        document["aifull-multi-action"].innerHTML = f"{player_name}, –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–±–∏—Ç—å—Å—è? –í–æ–∑—å–º–∏—Ç–µ –∫–∞—Ä—Ç—ã."

def ai_defense_multi(ai_idx):
    if len(table_cards_multi)!=1:
        return
    atk_card = table_cards_multi[0][1]
    possible = [c for c in hands[ai_idx] if can_defend(c, atk_card, trump_multi)]
    if possible:
        possible.sort(key=lambda x: rank_index(x[0]))
        def_card = possible[0]
        hands[ai_idx].remove(def_card)
        table_cards_multi.append((ai_idx, def_card))

        queue_message("aifull-multi", f"{get_ai_name(ai_idx)} –∑–∞—â–∏—â–∞–µ—Ç—Å—è –∫–∞—Ä—Ç–æ–π:")
        queue_card(def_card, "aifull-multi-visual-cards")
        queue_message("aifull-multi", "–ó–∞—â–∏—Ç–∞ —É—Å–ø–µ—à–Ω–∞!")
        queue_function(lambda: finish_con_multi(True))
    else:
        queue_message("aifull-multi", f"{get_ai_name(ai_idx)} –Ω–µ –æ—Ç–±–∏–ª—Å—è –∏ –±–µ—Ä—ë—Ç –∫–∞—Ä—Ç—ã.")
        queue_function(lambda: finish_con_multi(False))

def finish_con_multi(success):
    global current_attacker_multi
    document["take-cards-multi"].style.display = "none"
    attacker = current_attacker_multi
    defender = find_next_alive_player(attacker)
    if defender is None:
        return

    if success:
        discard_cards_bito("aifull-multi", "aifull-multi-visual-cards", "discard-pile-multi")
        current_attacker_multi = defender
    else:
        for owner_idx, crd in table_cards_multi:
            hands[defender].append(crd)
        document["aifull-multi-visual-cards"].clear()
        table_cards_multi.clear()
        nxt = find_next_alive_player(defender)
        if nxt is not None:
            current_attacker_multi = nxt

    table_cards_multi.clear()
    document["aifull-multi-visual-cards"].clear()

    if not game_over_multi_flag:
        multi_draw_cards_order(current_attacker_multi)
    update_aifull_multi_ui()
    if not game_over_multi_flag:
        start_con_multi()

def multi_draw_cards_order(attacker_idx):
    global deck_multi
    if not deck_multi:
        return
    order = []
    idx = attacker_idx
    while True:
        if not eliminated_multi[idx]:
            order.append(idx)
        idx = (idx+1) % n_players_multi
        if idx==attacker_idx:
            break
    for p in order:
        if not eliminated_multi[p]:
            hands[p] = draw_until_6(hands[p], deck_multi)

def take_cards_multi(ev):
    if len(table_cards_multi)==0:
        return

    # --- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: —è–≤–Ω–æ –≥–æ–≤–æ—Ä–∏–º –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
    document["aifull-multi-action"].innerHTML = "–í—ã –≤–∑—è–ª–∏ –∫–∞—Ä—Ç—ã!"

    for owner_idx, crd in table_cards_multi:
        hands[0].append(crd)
    table_cards_multi.clear()
    document["aifull-multi-visual-cards"].clear()
    document["take-cards-multi"].style.display = "none"

    attacker = current_attacker_multi
    defender = find_next_alive_player(attacker)
    if defender==0:
        nxt = find_next_alive_player(defender)
        if nxt is not None:
            current_attacker_multi = nxt
    else:
        nxt = find_next_alive_player(0)
        if nxt is not None:
            current_attacker_multi = nxt

    multi_draw_cards_order(current_attacker_multi)
    update_aifull_multi_ui()
    start_con_multi()

def find_next_alive_player(start):
    idx = (start+1) % n_players_multi
    while idx!=start:
        if not eliminated_multi[idx]:
            return idx
        idx = (idx+1) % n_players_multi
    return None

def get_ai_name(ai_idx):
    if ai_idx==1:return "–°–µ–ª–µ—Å—Ç–∏—è"
    elif ai_idx==2:return "–õ—é–º–∏–Ω"
    elif ai_idx==3:return "–ò—Ç–µ—Ä"
    return f"AI[{ai_idx}]"

def check_game_type_and_start(only_6plus, with_jokers, ai_count):
    if ai_count<2:
        ai_count=2
    elif ai_count>4:
        ai_count=4
    if ai_count==2:
        start_aifull_game(only_6plus, with_jokers)
    else:
        start_aifull_multi(only_6plus, with_jokers, ai_count)

def restart_aifull_multi():
    jokers_checked = document["cb_jokers"].checked
    sixplus_checked = document["cb_6plus"].checked
    ai_str = document["ai_players_count"].value
    try:
        ai_num = int(ai_str)
    except:
        ai_num = 3
    if ai_num<3: ai_num=3
    if ai_num>4: ai_num=4
    start_aifull_multi(sixplus_checked, jokers_checked, ai_num)

def start_new_game():
    mode_value = document["select_mode"].value
    jokers_checked = document["cb_jokers"].checked
    sixplus_checked = document["cb_6plus"].checked

    radio_list = document.select("[name='game_type']")
    game_type = "ai"
    for r in radio_list:
        if r.checked:
            game_type = r.value
            break

    if game_type=="ai":
        ai_count_str = document["ai_players_count"].value
        try:
            ai_count = int(ai_count_str)
        except:
            ai_count = 2
        if ai_count<2: ai_count=2
        if ai_count>4: ai_count=4
        check_game_type_and_start(sixplus_checked, jokers_checked, ai_count)
    else:
        multi_count_str = document["multi_players_count"].value
        try:
            multi_count = int(multi_count_str)
        except:
            multi_count = 4
        if multi_count<2: multi_count=2
        if multi_count>10: multi_count=10
        rlist = document.select("[name='room_type']")
        rt = "link"
        for rr in rlist:
            if rr.checked:
                rt = rr.value
                break
        document["chosen_mode"].textContent = mode_value
        document["chosen_jokers"].textContent = "–î–∞" if jokers_checked else "–ù–µ—Ç"
        document["chosen_6plus"].textContent = "–î–∞" if sixplus_checked else "–ù–µ—Ç"
        document["chosen_players"].textContent = str(multi_count)
        document["chosen_type"].textContent = "–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä"
        document["chosen_room"].textContent = "–ü–æ —Å—Å—ã–ª–∫–µ" if rt=="link" else "–û—Ç–∫—Ä—ã—Ç–∞—è"
        switch_view("game-screen")

document["take-cards-2p"].bind("click", take_cards_2p)
document["take-cards-multi"].bind("click", take_cards_multi)
    
window.open_screen = open_screen
window.back_to_menu = back_to_menu
window.save_player_name = save_player_name
window.start_new_game = start_new_game
window.restart_aifull = restart_aifull
window.restart_aifull_multi = restart_aifull_multi

if "aifull-log" in document:
    document["aifull-log"].style.display = "none"
if "aifull-multi-log" in document:
    document["aifull-multi-log"].style.display = "none"
</script>
</body>
</html>

